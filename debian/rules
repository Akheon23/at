#!/usr/bin/make -f

build: build-stamp
build-stamp:
	./configure --prefix=/usr \
		--with-loadavg_mx=1.5 \
		--with-jobdir=/var/spool/cron/atjobs \
		--with-atspool=/var/spool/cron/atspool
	sed -i 's,/usr/lib/sendmail,/usr/sbin/sendmail,g' config.h
	$(MAKE)
	touch $@

clean:
	[ ! -f Makefile ] || $(MAKE) distclean
	rm -rf *~ TAGS tags
	dh_clean

binary-indep:
# Nothing to be done here

binary-arch: build-stamp
	dh_testroot
	dh_prep
	# Install docs:
	dh_installchangelogs ChangeLog
	dh_installdocs README
	# Install everything:
	$(MAKE) IROOT=$(CURDIR)/debian/at mandir=/usr/share/man docdir=/usr/share/doc install
	# Remove (duplicate) copyright:
	rm debian/at/usr/share/doc/at/Copyright
	# TODO: Take care of those:
	rm -f debian/at/var/spool/cron/atjobs/.SEQ
	chown daemon:daemon debian/at/var/spool/cron/atjobs debian/at/var/spool/cron/atspool
	# Take care of the manpages:
	dh_installman
	mv debian/at/usr/share/man/man5/at_allow.5 \
		debian/at/usr/share/man/man5/at.allow.5
	rm debian/at/usr/share/man/man5/at_deny.5
	ln -sf at.allow.5 \
		debian/at/usr/share/man/man5/at.deny.5
	# TODO: Why removing those?
	rm debian/at/usr/sbin/atrun
	rm debian/at/usr/share/man/man8/atrun.8
	# Install/rename pam config file:
	dh_install pam.conf etc/pam.d
	mv debian/at/etc/pam.d/pam.conf \
		debian/at/etc/pam.d/atd
	# Install/rename init script:
	dh_install rc etc/init.d
	mv debian/at/etc/init.d/rc \
		debian/at/etc/init.d/atd
	chmod a+x debian/at/etc/init.d/atd
	# Needed to keep in line with the previous upload:
	chown root:daemon debian/at/etc/at.deny
	dh_compress
	dh_installdeb
	dh_shlibdeps
	dh_gencontrol
	dh_md5sums
	dh_builddeb

binary: binary-indep binary-arch

.PHONY: binary binary-arch binary-indep clean
